<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP-2010 å±…å®¶å®‰å…¨æ§åˆ¶å™¨</title>
    <!-- å¼•å…¥ Tailwind CSS CDN (ç”¨æ–¼æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        .btn-active {
            transform: scale(0.98);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- å¼•å…¥ React å’Œ ReactDOM CDN (ç”¨æ–¼æ ¸å¿ƒå‡½å¼åº«) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- å¼•å…¥ Babel è½‰æ› JSX (é€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ï¼Œè®“ç€è¦½å™¨ç†è§£ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <!-- é€™æ˜¯ React æ‡‰ç”¨ç¨‹å¼çš„æ›è¼‰é» -->
    <div id="root"></div>

    <!-- é—œéµ: è¨­ç½® type="text/babel" å‘Šè¨´ç€è¦½å™¨ä½¿ç”¨ Babel è™•ç† JSX -->
    <script type="text/babel">
        const { useState, useCallback, useMemo, useRef } = React;
        // å‡è¨­ Tailwind CSS åœ¨ç’°å¢ƒä¸­å¯ç”¨

        // --- è—ç‰™æœå‹™å’Œç‰¹æ€§ UUIDs ---
        // æ‚¨çš„ ESP32 éŸŒé«”å¿…é ˆä½¿ç”¨é€™äº› UUIDs
        const BLE_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'; // ç¤ºä¾‹ UART æœå‹™
        const BLE_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // å¯«å…¥ï¼ˆApp ç™¼é€æŒ‡ä»¤åˆ° ESP32ï¼‰
        const BLE_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // è®€å–/é€šçŸ¥ï¼ˆESP32 ç™¼é€æ•¸æ“šåˆ° Appï¼‰

        // æŒ‡ä»¤çµå°¾å®šç¾©
        const COMMAND_TERMINATOR = '\r'; // LP-2010 é™æ§æŒ‡ä»¤çµå°¾ (CR)
        const APP_TERMINATOR = '\n';    // ESP32 å‚³è¼¸æŒ‡ä»¤çµå°¾ (LF)

        // ç³»çµ±ç‹€æ…‹
        const SecurityState = {
            DISARMED: 'è§£é™¤è¨­é˜²',
            ARMED: 'è¨­é˜²ä¸­',
            ALARM_TRIGGERED: 'ğŸš¨ è­¦å ±è§¸ç™¼ï¼',
        };

        const App = () => {
            const [connectionStatus, setConnectionStatus] = useState('æœªé€£ç·š');
            const [isConnected, setIsConnected] = useState(false);
            const [securityState, setSecurityState] = useState(SecurityState.DISARMED);
            const [appLog, setAppLog] = useState([]);
            const [errorMessage, setErrorMessage] = useState(null); 
            const [isSending, setIsSending] = useState(false);

            // Web Bluetooth å¯¦ä¾‹åƒè€ƒ
            const deviceRef = useRef(null);
            const rxCharacteristicRef = useRef(null);
            const txCharacteristicRef = useRef(null);
            const pendingDataRef = useRef(''); // ç”¨æ–¼ç´¯ç©å¾ ESP32 æ¥æ”¶åˆ°çš„æ•¸æ“š

            // --- è¼”åŠ©å‡½å¼ ---

            const appendLog = useCallback((message) => {
                setAppLog(prev => [...prev.slice(-9), { timestamp: Date.now(), message }]); // åªä¿ç•™æœ€æ–°çš„ 10 æ¢æ—¥èªŒ
            }, []);

            const updateSecurityState = useCallback((status) => {
                const trimmedStatus = status.trim();
                if (trimmedStatus === 'ARMED') {
                    setSecurityState(SecurityState.ARMED);
                } else if (trimmedStatus === 'DISARMED') {
                    setSecurityState(SecurityState.DISARMED);
                } else if (trimmedStatus.startsWith('ALARM')) {
                    setSecurityState(SecurityState.ALARM_TRIGGERED);
                }
            }, []);

            // å°‡ ArrayBuffer è½‰æ›ç‚ºå­—ä¸²
            const decoder = useMemo(() => new TextDecoder('utf-8'), []);
            
            // --- è—ç‰™äº‹ä»¶è™•ç† ---

            const handleDisconnect = useCallback(() => {
                setIsConnected(false);
                setConnectionStatus('å·²æ–·é–‹é€£ç·š');
                deviceRef.current = null;
                rxCharacteristicRef.current = null;
                txCharacteristicRef.current = null;
                appendLog('LOG: è—ç‰™è£ç½®å·²æ–·é–‹ã€‚');
                setSecurityState(SecurityState.DISARMED);
            }, [appendLog]);
            
            // è™•ç†å¾ ESP32 æ¥æ”¶åˆ°çš„æ•¸æ“š (Notify äº‹ä»¶)
            const handleCharacteristicValueChanged = useCallback((event) => {
                const value = event.target.value;
                const receivedText = decoder.decode(value);
                
                pendingDataRef.current += receivedText;
                
                // ä½¿ç”¨ APP_TERMINATOR ('\n') åˆ†å‰²è¨Šæ¯ï¼Œè™•ç†å®Œæ•´çš„å‘½ä»¤
                const parts = pendingDataRef.current.split(APP_TERMINATOR);
                
                // æœ€å¾Œä¸€å€‹éƒ¨åˆ†å¯èƒ½æ˜¯æœªå®Œæ•´çš„è¨Šæ¯ï¼Œä¿ç•™
                pendingDataRef.current = parts.pop(); 

                parts.forEach(msg => {
                    const trimmedMsg = msg.trim();
                    if (trimmedMsg.startsWith('STATUS:')) {
                        updateSecurityState(trimmedMsg.substring(7));
                    }
                    // å°‡æ‰€æœ‰æ¥æ”¶åˆ°çš„å®Œæ•´è¨Šæ¯ï¼ˆåŒ…æ‹¬ LP_DATA, LOG, STATUSï¼‰è¨˜éŒ„ä¸‹ä¾†
                    appendLog(`RX: ${trimmedMsg}`);
                });

            }, [appendLog, decoder, updateSecurityState]);
            
            // --- æ ¸å¿ƒè—ç‰™æ“ä½œï¼šé€£ç·š/æ–·é–‹ ---

            const connect = useCallback(async () => {
                setErrorMessage(null);
                setConnectionStatus('æƒæè£ç½®ä¸­...');

                if (!navigator.bluetooth) {
                    setErrorMessage('éŒ¯èª¤ï¼šæ‚¨çš„è£ç½®ä¸æ”¯æŒ Web Bluetooth APIï¼Œè«‹ä½¿ç”¨ Android ç³»çµ±ä¸Šçš„ Chrome æˆ– Edge ç€è¦½å™¨ã€‚');
                    return;
                }

                try {
                    // 1. è«‹æ±‚è£ç½® (éæ¿¾å™¨å¯æ ¹æ“šéœ€è¦èª¿æ•´ï¼Œä¾‹å¦‚åŠ å…¥è£ç½®åç¨±)
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'ESP32' }, { namePrefix: 'BLE' }, { services: [BLE_UART_SERVICE_UUID] }],
                        optionalServices: [BLE_UART_SERVICE_UUID]
                    });

                    deviceRef.current = device;
                    device.addEventListener('gattserverdisconnected', handleDisconnect);

                    setConnectionStatus(`å˜—è©¦é€£ç·šè‡³ ${device.name}...`);
                    
                    // 2. é€£ç·š GATT ä¼ºæœå™¨
                    const server = await device.gatt.connect();

                    // 3. å–å¾—ä¸»è¦æœå‹™
                    const service = await server.getPrimaryService(BLE_UART_SERVICE_UUID);

                    // 4. å–å¾—ç‰¹æ€§
                    const rxCharacteristic = await service.getCharacteristic(BLE_RX_CHARACTERISTIC_UUID); // å¯«å…¥ç‰¹æ€§
                    const txCharacteristic = await service.getCharacteristic(BLE_TX_CHARACTERISTIC_UUID); // é€šçŸ¥ç‰¹æ€§

                    rxCharacteristicRef.current = rxCharacteristic;
                    txCharacteristicRef.current = txCharacteristic;

                    // 5. å•Ÿå‹•é€šçŸ¥ (Notify)
                    await txCharacteristic.startNotifications();
                    txCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
                    
                    // 6. é€£ç·šæˆåŠŸ
                    setIsConnected(true);
                    setConnectionStatus(`âœ… å·²é€£ç·šåˆ° ${device.name}`);
                    appendLog(`LOG: è—ç‰™é€£ç·šæˆåŠŸï¼è£ç½®åç¨±: ${device.name}`);
                    
                    // å‚³é€æŒ‡ä»¤è«‹æ±‚åˆå§‹ç‹€æ…‹ (å¦‚æœ ESP32 æ”¯æ´)
                    // sendCommand('GET_STATUS'); 

                } catch (error) {
                    setErrorMessage(`é€£ç·šå¤±æ•—: ${error.message}. è«‹ç¢ºèªè—ç‰™å·²é–‹å•Ÿä¸¦è£ç½®åœ¨é™„è¿‘ã€‚`);
                    setConnectionStatus('é€£ç·šå¤±æ•—');
                    handleDisconnect(); // æ¸…ç†ç‹€æ…‹
                }
            }, [handleDisconnect, handleCharacteristicValueChanged, appendLog]);


            const disconnect = useCallback(() => {
                if (deviceRef.current && deviceRef.current.gatt.connected) {
                    deviceRef.current.gatt.disconnect();
                } else {
                    handleDisconnect();
                }
            }, [handleDisconnect]);

            const handleConnect = useCallback(() => {
                if (isConnected) {
                    disconnect();
                } else {
                    connect();
                }
            }, [isConnected, connect, disconnect]);

            // æ ¸å¿ƒæŒ‡ä»¤ç™¼é€å‡½å¼
            const sendCommand = async (commandType, payload = '') => {
                if (!isConnected || !rxCharacteristicRef.current) {
                    setErrorMessage("è«‹å…ˆé€£ç·šåˆ° ESP32 è—ç‰™è£ç½®ã€‚");
                    return;
                }
                setErrorMessage(null); // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
                setIsSending(true);

                // æ§‹é€ å®Œæ•´çš„å‘½ä»¤å­—ç¬¦ä¸²
                const fullCommand = `${commandType}${payload}${APP_TERMINATOR}`;
                
                try {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(fullCommand);
                    
                    await rxCharacteristicRef.current.writeValue(data);

                    appendLog(`TX: ${fullCommand.trim()}`);

                } catch (error) {
                    setErrorMessage(`å‚³è¼¸å¤±æ•—: ${error.message}`);
                    console.error('Bluetooth Write Error:', error);
                } finally {
                    setIsSending(false);
                }
            };

            // æ§åˆ¶æŒ‰éˆ•é‚è¼¯
            const handleSystemControl = (action) => {
                switch (action) {
                    case 'ARM':
                        sendCommand('ARM');
                        break;
                    case 'DISARM':
                        sendCommand('DISARM');
                        break;
                    case 'STOP_ALARM':
                        sendCommand('STOP_ALARM'); 
                        break; 
                    case 'READ_CARD':
                        // ç›¤æŸ¥æŒ‡ä»¤ç‚º :INVENTORY + CR
                        sendCommand(':INVENTORY', COMMAND_TERMINATOR); 
                        break;
                    case 'LOCK':
                        sendCommand('LOCK'); 
                        break;
                    case 'UNLOCK':
                        sendCommand('UNLOCK'); 
                        break;
                    case 'TOGGLE_LIGHT':
                        sendCommand('TOGGLE_LIGHT'); 
                        break;
                    default:
                        console.warn('æœªçŸ¥æ§åˆ¶æŒ‡ä»¤');
                }
            };

            // ç³»çµ±ç‹€æ…‹åº•è‰²
            const statusColor = useMemo(() => {
                switch (securityState) {
                    case SecurityState.ARMED:
                        return 'bg-amber-500 shadow-amber-300/50'; // æ©™è‰² (è¨­é˜²ä¸­)
                    case SecurityState.ALARM_TRIGGERED:
                        return 'bg-red-700 shadow-red-500/50'; // æ·±ç´…è‰² (è­¦å ±)
                    case SecurityState.DISARMED:
                    default:
                        return 'bg-green-600 shadow-green-400/50'; // ç¶ è‰² (è§£é™¤)
                }
            }, [securityState]);

            // --- UI æ¸²æŸ“ ---

            const renderLog = ({ timestamp, message }) => (
                <p key={timestamp + message} className="text-xs border-b border-gray-100 py-1 last:border-b-0 text-gray-700 break-all">
                    <span className="font-bold text-gray-500 mr-2">{new Date(timestamp).toLocaleTimeString()}</span>
                    {message}
                </p>
            );

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-6 flex justify-center items-start">
                    <div className="w-full max-w-sm bg-white rounded-2xl shadow-2xl space-y-4 p-4 sm:p-6 border border-gray-100">
                        <h1 className="text-2xl font-extrabold text-center text-gray-800 border-b pb-3">
                            è¡Œå‹•å®‰å…¨ç³»çµ±æ§åˆ¶å™¨
                        </h1>
                        
                        {/* é€£ç·šå€ */}
                        <button 
                            className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all duration-200 
                                ${isConnected ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'} 
                                ${isSending ? 'opacity-50 cursor-wait' : ''}`}
                            onClick={handleConnect}
                            disabled={isSending}
                        >
                            {isConnected ? 'é»æ“Šæ–·é–‹é€£ç·š' : 'é€£ç·š ESP32 (BLE)'}
                        </button>

                        <p className={`text-center font-semibold text-lg ${isConnected ? 'text-green-600' : 'text-red-500'}`}>
                            ç‹€æ…‹: {connectionStatus}
                        </p>

                        {/* éŒ¯èª¤è¨Šæ¯å€ */}
                        {errorMessage && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-lg relative text-sm" role="alert">
                                <strong className="font-bold">éŒ¯èª¤: </strong>
                                <span className="block sm:inline">{errorMessage}</span>
                            </div>
                        )}
                        
                        {/* æç¤ºå€ (é‡å°è¡Œå‹•è£ç½®ç”¨æˆ¶) */}
                        {!isConnected && !errorMessage && (
                            <div className="bg-blue-100 text-blue-800 p-3 rounded-lg text-sm">
                                æ­¤ä»‹é¢ç‚º **Web Bluetooth** æ‡‰ç”¨ï¼Œè«‹åœ¨ **Android ä¸Šçš„ Chrome ç€è¦½å™¨**ä¸­é–‹å•Ÿï¼Œä»¥ç¢ºä¿è—ç‰™åŠŸèƒ½å¯ç”¨ã€‚
                            </div>
                        )}

                        {/* æ ¸å¿ƒç‹€æ…‹å€ */}
                        <div className={`${statusColor} p-4 rounded-xl my-3 text-center shadow-xl transition-all duration-300`}>
                            <p className="text-2xl font-black text-white">{securityState}</p>
                        </div>

                        {/* è­¦å ±è™•ç†å€ */}
                        {securityState === SecurityState.ALARM_TRIGGERED && (
                            <button 
                                className="w-full py-3 rounded-lg font-extrabold text-white bg-red-600 hover:bg-red-700 shadow-xl transition-transform transform hover:scale-[1.01]"
                                onClick={() => handleSystemControl('STOP_ALARM')}
                                disabled={isSending}
                            >
                                ğŸš¨ åœæ­¢è­¦å ±
                            </button>
                        )}

                        {/* ç³»çµ±è¨­é˜²æ§åˆ¶ */}
                        <p className="text-base font-semibold mt-4 mb-2 text-gray-700">å®‰å…¨é˜²è­·</p>
                        <div className="flex justify-between space-x-2">
                            <button 
                                className={`flex-1 py-3 rounded-lg font-bold text-gray-900 shadow-md transition-all duration-200 
                                    ${securityState === SecurityState.ARMED || !isConnected || isSending ? 'bg-gray-300 cursor-not-allowed' : 'bg-yellow-400 hover:bg-yellow-500 active:btn-active'}`}
                                onClick={() => handleSystemControl('ARM')}
                                disabled={securityState === SecurityState.ARMED || !isConnected || isSending}
                            >
                                è¨­é˜² (ARM)
                            </button>
                            <button 
                                className={`flex-1 py-3 rounded-lg font-bold text-gray-900 shadow-md transition-all duration-200 
                                    ${securityState === SecurityState.DISARMED || !isConnected || isSending ? 'bg-gray-300 cursor-not-allowed' : 'bg-lime-400 hover:bg-lime-500 active:btn-active'}`}
                                onClick={() => handleSystemControl('DISARM')}
                                disabled={securityState === SecurityState.DISARMED || !isConnected || isSending}
                            >
                                è§£é™¤ (DISARM)
                            </button>
                        </div>

                        {/* é–€ç¦èˆ‡ RFID */}
                        <p className="text-base font-semibold mt-4 mb-2 text-gray-700 border-t pt-3">é–€ç¦èˆ‡æ§åˆ¶</p>
                        <div className="grid grid-cols-3 gap-2">
                            <button 
                                className={`py-3 rounded-lg font-bold text-white shadow-md text-sm transition-all duration-200 
                                    ${!isConnected || isSending ? 'bg-gray-400 cursor-not-allowed' : 'bg-cyan-600 hover:bg-cyan-700 active:btn-active'}`}
                                onClick={() => handleSystemControl('READ_CARD')}
                                disabled={!isConnected || isSending}
                            >
                                ç›¤æŸ¥ RFID
                            </button>
                            <button 
                                className={`py-3 rounded-lg font-bold text-white shadow-md transition-all duration-200 
                                    ${!isConnected || isSending ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-400 hover:bg-red-500 active:btn-active'}`}
                                onClick={() => handleSystemControl('LOCK')}
                                disabled={!isConnected || isSending}
                            >
                                ä¸Šé–
                            </button>
                            <button 
                                className={`py-3 rounded-lg font-bold text-white shadow-md transition-all duration-200 
                                    ${!isConnected || isSending ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-400 hover:bg-green-500 active:btn-active'}`}
                                onClick={() => handleSystemControl('UNLOCK')}
                                disabled={!isConnected || isSending}
                            >
                                é–‹é–
                            </button>
                        </div>

                        {/* ç…§æ˜æ§åˆ¶ */}
                        <button 
                            className={`w-full py-3 rounded-lg font-bold text-white shadow-md transition-all duration-200 mt-4 
                                ${!isConnected || isSending ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 active:btn-active'}`}
                            onClick={() => handleSystemControl('TOGGLE_LIGHT')}
                            disabled={!isConnected || isSending}
                        >
                            é–‹/é—œ ç…§æ˜ (Relay 1)
                        </button>


                        {/* Log å€ */}
                        <p className="text-sm font-bold mt-4 pt-3 border-t text-gray-600 text-center">--- å³æ™‚é€šè¨Šæ—¥èªŒ ---</p>
                        <div className="log-container bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-inner">
                            <div className="flex flex-col-reverse">
                                {/* é¡¯ç¤ºæ—¥èªŒ */}
                                {appLog.slice().reverse().map(renderLog)}
                                {appLog.length === 0 && <p className="text-xs text-center text-gray-400">é€£ç·šæˆåŠŸå¾Œå°‡é¡¯ç¤ºç™¼é€/æ¥æ”¶æ•¸æ“šã€‚</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        const rootElement = document.getElementById('root');
        if (rootElement) {
            ReactDOM.createRoot(rootElement).render(<App />);
        }
    </script>
</body>
</html>




