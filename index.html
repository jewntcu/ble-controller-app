import React, { useState, useCallback, useMemo, useRef } from 'react';

// 假設 Tailwind CSS 在環境中可用

// --- 藍牙服務和特性 UUIDs ---
// 您的 ESP32 韌體必須使用這些 UUIDs
const BLE_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'; // 示例 UART 服務
const BLE_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // 寫入（App 發送指令到 ESP32）
const BLE_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // 讀取/通知（ESP32 發送數據到 App）

// 指令結尾定義
const APP_TERMINATOR = '\n'; // ESP32 傳輸指令結尾 (LF)

// 系統狀態
const SecurityState = {
  DISARMED: '解除設防',
  ARMED: '設防中',
  ALARM_TRIGGERED: '🚨 警報觸發！',
};

const App = () => {
  const [connectionStatus, setConnectionStatus] = useState('未連線');
  const [isConnected, setIsConnected] = useState(false);
  const [securityState, setSecurityState] = useState(SecurityState.DISARMED);
  const [appLog, setAppLog] = useState([]);
  const [errorMessage, setErrorMessage] = useState(null);
  const [isSending, setIsSending] = useState(false);
  const [isBusy, setIsBusy] = useState(false); // 用於長時間操作 (例如讀取日誌)
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalMessage, setModalMessage] = useState('');

  // Web Bluetooth 實例參考
  const deviceRef = useRef(null);
  const rxCharacteristicRef = useRef(null);
  const txCharacteristicRef = useRef(null);
  const pendingDataRef = useRef(''); // 用於累積從 ESP32 接收到的數據

  // --- 輔助函式 ---

  const showMessage = useCallback((message) => {
    setModalMessage(message);
    setIsModalOpen(true);
  }, []);

  const appendLog = useCallback((message) => {
    setAppLog(prev => [{ timestamp: Date.now(), message, id: Math.random() }, ...prev.slice(0, 9)]); // 保留最新的 10 條日誌，新的在最上面
  }, []);

  const updateSecurityState = useCallback((status) => {
    const trimmedStatus = status.trim();
    if (trimmedStatus === 'ARMED') {
      setSecurityState(SecurityState.ARMED);
    } else if (trimmedStatus === 'DISARMED') {
      setSecurityState(SecurityState.DISARMED);
    } else if (trimmedStatus.startsWith('ALARM')) {
      setSecurityState(SecurityState.ALARM_TRIGGERED);
      showMessage('🚨 警報已觸發！請解除設防。');
    }
  }, [showMessage]);

  // 將 ArrayBuffer 轉換為字串
  const decoder = useMemo(() => new TextDecoder('utf-8'), []);

  // --- 藍牙事件處理 ---

  const handleDisconnect = useCallback(() => {
    setIsConnected(false);
    setConnectionStatus('已斷開連線');
    deviceRef.current = null;
    rxCharacteristicRef.current = null;
    txCharacteristicRef.current = null;
    appendLog('LOG: 藍牙裝置已斷開。');
    setSecurityState(SecurityState.DISARMED);
    setIsBusy(false);
  }, [appendLog]);

  // 處理從 ESP32 接收到的數據 (Notify 事件)
  const handleCharacteristicValueChanged = useCallback((event) => {
    const value = event.target.value;
    const receivedText = decoder.decode(value);
    pendingDataRef.current += receivedText;

    // 使用 APP_TERMINATOR ('\n') 分割訊息，處理完整的命令
    const parts = pendingDataRef.current.split(APP_TERMINATOR);
    // 最後一個部分可能是未完整的訊息，保留
    pendingDataRef.current = parts.pop();

    parts.forEach(msg => {
      const trimmedMsg = msg.trim();
      if (!trimmedMsg) return;

      if (trimmedMsg.startsWith('STATUS:')) {
        updateSecurityState(trimmedMsg.substring(7));
      } else if (trimmedMsg.startsWith('ALERT:')) {
        showMessage(trimmedMsg.substring(6));
      } else if (trimmedMsg.startsWith('LOG_DATA:')) {
        // 處理長數據 (日誌或盤查結果)
        const data = trimmedMsg.substring(9);
        appendLog(`DATA: ${data}`);
        if (data.includes('讀取完成') || data.includes('Inventory END')) {
          setIsBusy(false);
        }
      } else {
        // 記錄所有其他訊息 (LOG:, LP_DATA:, etc.)
        appendLog(`RX: ${trimmedMsg}`);
        // 檢查日誌結束標記
        if (trimmedMsg.includes('讀取完成') || trimmedMsg.includes('Inventory END')) {
          setIsBusy(false);
        }
      }
    });
  }, [appendLog, decoder, updateSecurityState, showMessage]);

  // --- 核心藍牙操作：連線/斷開 ---

  const connect = useCallback(async () => {
    setErrorMessage(null);
    setConnectionStatus('掃描裝置中...');

    if (!navigator.bluetooth) {
      setErrorMessage('錯誤：您的裝置不支持 Web Bluetooth API，請使用 Android 系統上的 Chrome 或 Edge 瀏覽器。');
      return;
    }

    try {
      // 1. 請求裝置 (過濾器)
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'ESP32' }], // 過濾名稱
        optionalServices: [BLE_UART_SERVICE_UUID]
      });

      deviceRef.current = device;
      device.addEventListener('gattserverdisconnected', handleDisconnect);
      setConnectionStatus(`嘗試連線至 ${device.name}...`);

      // 2. 連線 GATT 伺服器
      const server = await device.gatt.connect();

      // 3. 取得主要服務
      const service = await server.getPrimaryService(BLE_UART_SERVICE_UUID);

      // 4. 取得特性
      const rxCharacteristic = await service.getCharacteristic(BLE_RX_CHARACTERISTIC_UUID); // 寫入特性 (App -> ESP32)
      const txCharacteristic = await service.getCharacteristic(BLE_TX_CHARACTERISTIC_UUID); // 通知特性 (ESP32 -> App)

      rxCharacteristicRef.current = rxCharacteristic;
      txCharacteristicRef.current = txCharacteristic;

      // 5. 啟動通知 (Notify)
      await txCharacteristic.startNotifications();
      txCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

      // 6. 連線成功
      setIsConnected(true);
      setConnectionStatus(`✅ 已連線到 ${device.name}`);
      appendLog(`LOG: 藍牙連線成功！裝置名稱: ${device.name}`);

    } catch (error) {
      const msg = error.message.includes("cancelled") ? "連線操作已取消" : `連線失敗: ${error.message}`;
      setErrorMessage(msg);
      setConnectionStatus('連線失敗');
      handleDisconnect(); // 清理狀態
    }
  }, [handleDisconnect, handleCharacteristicValueChanged, appendLog]);

  const disconnect = useCallback(() => {
    if (deviceRef.current && deviceRef.current.gatt.connected) {
      deviceRef.current.gatt.disconnect();
    } else {
      handleDisconnect();
    }
  }, [handleDisconnect]);

  const handleConnect = useCallback(() => {
    if (isConnected) {
      disconnect();
    } else {
      connect();
    }
  }, [isConnected, connect, disconnect]);

  // 核心指令發送函式
  const sendCommand = async (command) => {
    if (!rxCharacteristicRef.current || isSending || isBusy) {
      setErrorMessage('裝置未連線或正在忙碌中。');
      return;
    }

    // 對於會產生大量回覆的指令，設定忙碌狀態
    if (command === 'READ_LOG' || command === 'INVENTORY') {
      setIsBusy(true);
      appendLog(`TX: ${command} (啟動數據讀取...)`);
      showMessage('正在讀取資料，請稍候...');
    } else {
      appendLog(`TX: ${command}`);
    }

    try {
      setIsSending(true);
      const data = new TextEncoder().encode(command + APP_TERMINATOR);
      await rxCharacteristicRef.current.writeValue(data);
    } catch (error) {
      setErrorMessage(`發送指令失敗: ${error.message}`);
      // 如果發送失敗，且處於忙碌狀態，則解除忙碌
      if (isBusy) setIsBusy(false); 
    } finally {
      setIsSending(false);
    }
  };

  // 渲染按鈕的樣式函式
  const getButtonClasses = (variant) => {
    const base = "w-full py-4 text-white font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:shadow-none";
    switch (variant) {
      case 'arm':
        return securityState === SecurityState.ARMED ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700';
      case 'disarm':
        return securityState === SecurityState.DISARMED ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700';
      case 'alarm':
        return securityState === SecurityState.ALARM_TRIGGERED ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-gray-500 hover:bg-gray-600';
      case 'control':
        return 'bg-blue-600 hover:bg-blue-700';
      case 'data':
        return 'bg-purple-600 hover:bg-purple-700';
      case 'connect':
        return isConnected ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-600 hover:bg-indigo-700';
      default:
        return 'bg-gray-500 hover:bg-gray-600';
    }
  };
  
  const StatusPill = ({ state }) => {
      let colorClass = 'bg-yellow-500';
      if (state === SecurityState.ARMED) colorClass = 'bg-red-600';
      if (state === SecurityState.DISARMED) colorClass = 'bg-green-600';
      if (state === SecurityState.ALARM_TRIGGERED) colorClass = 'bg-orange-600 animate-pulse';

      return (
          <div className={`px-4 py-2 rounded-full text-white text-sm font-semibold shadow-md ${colorClass}`}>
              {state}
          </div>
      );
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4 font-inter">
      {/* 頂部狀態列 */}
      <header className="flex flex-col items-center justify-center p-4 bg-white rounded-2xl shadow-xl mb-4">
        <h1 className="text-2xl font-extrabold text-gray-800 mb-2">行動安全系統控制器</h1>
        <StatusPill state={securityState} />
        <p className={`text-sm mt-2 font-medium ${isConnected ? 'text-green-600' : 'text-gray-500'}`}>
          連線狀態: {connectionStatus}
        </p>
      </header>

      {/* 錯誤訊息區域 */}
      {errorMessage && (
        <div className="p-3 mb-4 text-sm text-white bg-red-500 rounded-lg shadow-md" role="alert">
          {errorMessage}
        </div>
      )}

      {/* 連線按鈕 */}
      <div className="mb-6">
        <button
          onClick={handleConnect}
          className={getButtonClasses('connect')}
          disabled={isSending || isBusy}
        >
          {isConnected ? '斷開連線' : '連線藍牙 (ESP32_Security_Module)'}
        </button>
      </div>

      {/* 控制面板 */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        {/* 設防/解除按鈕 */}
        <button
          onClick={() => sendCommand('ARM')}
          className={getButtonClasses('arm')}
          disabled={!isConnected || securityState === SecurityState.ARMED || isSending || isBusy}
        >
          設防 (ARM)
        </button>
        <button
          onClick={() => sendCommand('DISARM')}
          className={getButtonClasses('disarm')}
          disabled={!isConnected || securityState === SecurityState.DISARMED || isSending || isBusy}
        >
          解除設防 (DISARM)
        </button>
        {/* 緊急警報停止 */}
        <button
          onClick={() => sendCommand('STOP_ALARM')}
          className={getButtonClasses('alarm')}
          disabled={!isConnected || securityState !== SecurityState.ALARM_TRIGGERED || isSending || isBusy}
        >
          停止警報 (Stop)
        </button>
      </div>
      
      {/* 門鎖與照明控制 */}
      <h2 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-1">裝置控制</h2>
      <div className="grid grid-cols-2 gap-4 mb-6">
        <button
          onClick={() => sendCommand('LOCK')}
          className={getButtonClasses('control')}
          disabled={!isConnected || isSending || isBusy}
        >
          上鎖 (Lock)
        </button>
        <button
          onClick={() => sendCommand('UNLOCK')}
          className={getButtonClasses('control')}
          disabled={!isConnected || isSending || isBusy}
        >
          解鎖 (Unlock)
        </button>
        <button
          onClick={() => sendCommand('TOGGLE_LIGHT')}
          className={`${getButtonClasses('control')} col-span-2`}
          disabled={!isConnected || isSending || isBusy}
        >
          切換照明 (Toggle Light)
        </button>
      </div>

      {/* 資料操作 */}
      <h2 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-1">資料/感應器操作</h2>
      <div className="grid grid-cols-2 gap-4 mb-6">
        <button
          onClick={() => sendCommand('READ_LOG')}
          className={getButtonClasses('data')}
          disabled={!isConnected || isSending || isBusy}
        >
          讀取紀錄
        </button>
        <button
          onClick={() => sendCommand('INVENTORY')}
          className={getButtonClasses('data')}
          disabled={!isConnected || isSending || isBusy}
        >
          盤查卡片
        </button>
      </div>
      
      {/* 系統日誌 */}
      <h2 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-1">系統日誌</h2>
      <div className="bg-white p-3 rounded-xl shadow-inner h-64 overflow-y-scroll text-xs text-gray-700 space-y-1">
        {appLog.length === 0 ? (
          <p className="text-center text-gray-400 mt-10">等待藍牙訊息...</p>
        ) : (
          appLog.map((entry) => (
            <div key={entry.id} className="border-b border-gray-100 pb-1 last:border-b-0">
              <span className="font-mono text-[10px] text-gray-400 mr-2">
                [{new Date(entry.timestamp).toLocaleTimeString()}]
              </span>
              <span className={`${entry.message.startsWith('TX:') ? 'font-medium text-blue-600' : 
                                entry.message.startsWith('ALERT:') ? 'text-red-600 font-bold' : 
                                entry.message.startsWith('LOG:') ? 'text-green-600' : 
                                'text-gray-700'}`}>
                {entry.message}
              </span>
            </div>
          ))
        )}
      </div>

      {/* Loading Indicator */}
      {(isSending || isBusy) && (
        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
          <div className="text-white text-lg font-bold p-4 bg-gray-800 rounded-lg shadow-2xl">
            {isBusy ? '數據處理中...' : '發送中...'}
          </div>
        </div>
      )}

      {/* Custom Modal for Alerts */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full transform transition-all scale-100">
            <h3 className="text-xl font-bold mb-3 text-red-600">系統通知</h3>
            <p className="text-gray-700 mb-4">{modalMessage}</p>
            <button
              onClick={() => setIsModalOpen(false)}
              className="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700"
            >
              確定
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;







