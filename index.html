import React, { useState, useCallback, useMemo, useRef } from 'react';

// å‡è¨­ Tailwind CSS åœ¨ç’°å¢ƒä¸­å¯ç”¨

// --- è—ç‰™æœå‹™å’Œç‰¹æ€§ UUIDs ---
// æ‚¨çš„ ESP32 éŸŒé«”å¿…é ˆä½¿ç”¨é€™äº› UUIDs
const BLE_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'; // ç¤ºä¾‹ UART æœå‹™
const BLE_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // å¯«å…¥ï¼ˆApp ç™¼é€æŒ‡ä»¤åˆ° ESP32ï¼‰
const BLE_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // è®€å–/é€šçŸ¥ï¼ˆESP32 ç™¼é€æ•¸æ“šåˆ° Appï¼‰

// æŒ‡ä»¤çµå°¾å®šç¾©
const APP_TERMINATOR = '\n'; // ESP32 å‚³è¼¸æŒ‡ä»¤çµå°¾ (LF)

// ç³»çµ±ç‹€æ…‹
const SecurityState = {
  DISARMED: 'è§£é™¤è¨­é˜²',
  ARMED: 'è¨­é˜²ä¸­',
  ALARM_TRIGGERED: 'ğŸš¨ è­¦å ±è§¸ç™¼ï¼',
};

const App = () => {
  const [connectionStatus, setConnectionStatus] = useState('æœªé€£ç·š');
  const [isConnected, setIsConnected] = useState(false);
  const [securityState, setSecurityState] = useState(SecurityState.DISARMED);
  const [appLog, setAppLog] = useState([]);
  const [errorMessage, setErrorMessage] = useState(null);
  const [isSending, setIsSending] = useState(false);
  const [isBusy, setIsBusy] = useState(false); // ç”¨æ–¼é•·æ™‚é–“æ“ä½œ (ä¾‹å¦‚è®€å–æ—¥èªŒ)
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalMessage, setModalMessage] = useState('');

  // Web Bluetooth å¯¦ä¾‹åƒè€ƒ
  const deviceRef = useRef(null);
  const rxCharacteristicRef = useRef(null);
  const txCharacteristicRef = useRef(null);
  const pendingDataRef = useRef(''); // ç”¨æ–¼ç´¯ç©å¾ ESP32 æ¥æ”¶åˆ°çš„æ•¸æ“š

  // --- è¼”åŠ©å‡½å¼ ---

  const showMessage = useCallback((message) => {
    setModalMessage(message);
    setIsModalOpen(true);
  }, []);

  const appendLog = useCallback((message) => {
    setAppLog(prev => [{ timestamp: Date.now(), message, id: Math.random() }, ...prev.slice(0, 9)]); // ä¿ç•™æœ€æ–°çš„ 10 æ¢æ—¥èªŒï¼Œæ–°çš„åœ¨æœ€ä¸Šé¢
  }, []);

  const updateSecurityState = useCallback((status) => {
    const trimmedStatus = status.trim();
    if (trimmedStatus === 'ARMED') {
      setSecurityState(SecurityState.ARMED);
    } else if (trimmedStatus === 'DISARMED') {
      setSecurityState(SecurityState.DISARMED);
    } else if (trimmedStatus.startsWith('ALARM')) {
      setSecurityState(SecurityState.ALARM_TRIGGERED);
      showMessage('ğŸš¨ è­¦å ±å·²è§¸ç™¼ï¼è«‹è§£é™¤è¨­é˜²ã€‚');
    }
  }, [showMessage]);

  // å°‡ ArrayBuffer è½‰æ›ç‚ºå­—ä¸²
  const decoder = useMemo(() => new TextDecoder('utf-8'), []);

  // --- è—ç‰™äº‹ä»¶è™•ç† ---

  const handleDisconnect = useCallback(() => {
    setIsConnected(false);
    setConnectionStatus('å·²æ–·é–‹é€£ç·š');
    deviceRef.current = null;
    rxCharacteristicRef.current = null;
    txCharacteristicRef.current = null;
    appendLog('LOG: è—ç‰™è£ç½®å·²æ–·é–‹ã€‚');
    setSecurityState(SecurityState.DISARMED);
    setIsBusy(false);
  }, [appendLog]);

  // è™•ç†å¾ ESP32 æ¥æ”¶åˆ°çš„æ•¸æ“š (Notify äº‹ä»¶)
  const handleCharacteristicValueChanged = useCallback((event) => {
    const value = event.target.value;
    const receivedText = decoder.decode(value);
    pendingDataRef.current += receivedText;

    // ä½¿ç”¨ APP_TERMINATOR ('\n') åˆ†å‰²è¨Šæ¯ï¼Œè™•ç†å®Œæ•´çš„å‘½ä»¤
    const parts = pendingDataRef.current.split(APP_TERMINATOR);
    // æœ€å¾Œä¸€å€‹éƒ¨åˆ†å¯èƒ½æ˜¯æœªå®Œæ•´çš„è¨Šæ¯ï¼Œä¿ç•™
    pendingDataRef.current = parts.pop();

    parts.forEach(msg => {
      const trimmedMsg = msg.trim();
      if (!trimmedMsg) return;

      if (trimmedMsg.startsWith('STATUS:')) {
        updateSecurityState(trimmedMsg.substring(7));
      } else if (trimmedMsg.startsWith('ALERT:')) {
        showMessage(trimmedMsg.substring(6));
      } else if (trimmedMsg.startsWith('LOG_DATA:')) {
        // è™•ç†é•·æ•¸æ“š (æ—¥èªŒæˆ–ç›¤æŸ¥çµæœ)
        const data = trimmedMsg.substring(9);
        appendLog(`DATA: ${data}`);
        if (data.includes('è®€å–å®Œæˆ') || data.includes('Inventory END')) {
          setIsBusy(false);
        }
      } else {
        // è¨˜éŒ„æ‰€æœ‰å…¶ä»–è¨Šæ¯ (LOG:, LP_DATA:, etc.)
        appendLog(`RX: ${trimmedMsg}`);
        // æª¢æŸ¥æ—¥èªŒçµæŸæ¨™è¨˜
        if (trimmedMsg.includes('è®€å–å®Œæˆ') || trimmedMsg.includes('Inventory END')) {
          setIsBusy(false);
        }
      }
    });
  }, [appendLog, decoder, updateSecurityState, showMessage]);

  // --- æ ¸å¿ƒè—ç‰™æ“ä½œï¼šé€£ç·š/æ–·é–‹ ---

  const connect = useCallback(async () => {
    setErrorMessage(null);
    setConnectionStatus('æƒæè£ç½®ä¸­...');

    if (!navigator.bluetooth) {
      setErrorMessage('éŒ¯èª¤ï¼šæ‚¨çš„è£ç½®ä¸æ”¯æŒ Web Bluetooth APIï¼Œè«‹ä½¿ç”¨ Android ç³»çµ±ä¸Šçš„ Chrome æˆ– Edge ç€è¦½å™¨ã€‚');
      return;
    }

    try {
      // 1. è«‹æ±‚è£ç½® (éæ¿¾å™¨)
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'ESP32' }], // éæ¿¾åç¨±
        optionalServices: [BLE_UART_SERVICE_UUID]
      });

      deviceRef.current = device;
      device.addEventListener('gattserverdisconnected', handleDisconnect);
      setConnectionStatus(`å˜—è©¦é€£ç·šè‡³ ${device.name}...`);

      // 2. é€£ç·š GATT ä¼ºæœå™¨
      const server = await device.gatt.connect();

      // 3. å–å¾—ä¸»è¦æœå‹™
      const service = await server.getPrimaryService(BLE_UART_SERVICE_UUID);

      // 4. å–å¾—ç‰¹æ€§
      const rxCharacteristic = await service.getCharacteristic(BLE_RX_CHARACTERISTIC_UUID); // å¯«å…¥ç‰¹æ€§ (App -> ESP32)
      const txCharacteristic = await service.getCharacteristic(BLE_TX_CHARACTERISTIC_UUID); // é€šçŸ¥ç‰¹æ€§ (ESP32 -> App)

      rxCharacteristicRef.current = rxCharacteristic;
      txCharacteristicRef.current = txCharacteristic;

      // 5. å•Ÿå‹•é€šçŸ¥ (Notify)
      await txCharacteristic.startNotifications();
      txCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

      // 6. é€£ç·šæˆåŠŸ
      setIsConnected(true);
      setConnectionStatus(`âœ… å·²é€£ç·šåˆ° ${device.name}`);
      appendLog(`LOG: è—ç‰™é€£ç·šæˆåŠŸï¼è£ç½®åç¨±: ${device.name}`);

    } catch (error) {
      const msg = error.message.includes("cancelled") ? "é€£ç·šæ“ä½œå·²å–æ¶ˆ" : `é€£ç·šå¤±æ•—: ${error.message}`;
      setErrorMessage(msg);
      setConnectionStatus('é€£ç·šå¤±æ•—');
      handleDisconnect(); // æ¸…ç†ç‹€æ…‹
    }
  }, [handleDisconnect, handleCharacteristicValueChanged, appendLog]);

  const disconnect = useCallback(() => {
    if (deviceRef.current && deviceRef.current.gatt.connected) {
      deviceRef.current.gatt.disconnect();
    } else {
      handleDisconnect();
    }
  }, [handleDisconnect]);

  const handleConnect = useCallback(() => {
    if (isConnected) {
      disconnect();
    } else {
      connect();
    }
  }, [isConnected, connect, disconnect]);

  // æ ¸å¿ƒæŒ‡ä»¤ç™¼é€å‡½å¼
  const sendCommand = async (command) => {
    if (!rxCharacteristicRef.current || isSending || isBusy) {
      setErrorMessage('è£ç½®æœªé€£ç·šæˆ–æ­£åœ¨å¿™ç¢Œä¸­ã€‚');
      return;
    }

    // å°æ–¼æœƒç”¢ç”Ÿå¤§é‡å›è¦†çš„æŒ‡ä»¤ï¼Œè¨­å®šå¿™ç¢Œç‹€æ…‹
    if (command === 'READ_LOG' || command === 'INVENTORY') {
      setIsBusy(true);
      appendLog(`TX: ${command} (å•Ÿå‹•æ•¸æ“šè®€å–...)`);
      showMessage('æ­£åœ¨è®€å–è³‡æ–™ï¼Œè«‹ç¨å€™...');
    } else {
      appendLog(`TX: ${command}`);
    }

    try {
      setIsSending(true);
      const data = new TextEncoder().encode(command + APP_TERMINATOR);
      await rxCharacteristicRef.current.writeValue(data);
    } catch (error) {
      setErrorMessage(`ç™¼é€æŒ‡ä»¤å¤±æ•—: ${error.message}`);
      // å¦‚æœç™¼é€å¤±æ•—ï¼Œä¸”è™•æ–¼å¿™ç¢Œç‹€æ…‹ï¼Œå‰‡è§£é™¤å¿™ç¢Œ
      if (isBusy) setIsBusy(false); 
    } finally {
      setIsSending(false);
    }
  };

  // æ¸²æŸ“æŒ‰éˆ•çš„æ¨£å¼å‡½å¼
  const getButtonClasses = (variant) => {
    const base = "w-full py-4 text-white font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:shadow-none";
    switch (variant) {
      case 'arm':
        return securityState === SecurityState.ARMED ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700';
      case 'disarm':
        return securityState === SecurityState.DISARMED ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700';
      case 'alarm':
        return securityState === SecurityState.ALARM_TRIGGERED ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-gray-500 hover:bg-gray-600';
      case 'control':
        return 'bg-blue-600 hover:bg-blue-700';
      case 'data':
        return 'bg-purple-600 hover:bg-purple-700';
      case 'connect':
        return isConnected ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-600 hover:bg-indigo-700';
      default:
        return 'bg-gray-500 hover:bg-gray-600';
    }
  };
  
  const StatusPill = ({ state }) => {
      let colorClass = 'bg-yellow-500';
      if (state === SecurityState.ARMED) colorClass = 'bg-red-600';
      if (state === SecurityState.DISARMED) colorClass = 'bg-green-600';
      if (state === SecurityState.ALARM_TRIGGERED) colorClass = 'bg-orange-600 animate-pulse';

      return (
          <div className={`px-4 py-2 rounded-full text-white text-sm font-semibold shadow-md ${colorClass}`}>
              {state}
          </div>
      );
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4 font-inter">
      {/* é ‚éƒ¨ç‹€æ…‹åˆ— */}
      <header className="flex flex-col items-center justify-center p-4 bg-white rounded-2xl shadow-xl mb-4">
        <h1 className="text-2xl font-extrabold text-gray-800 mb-2">è¡Œå‹•å®‰å…¨ç³»çµ±æ§åˆ¶å™¨</h1>
        <StatusPill state={securityState} />
        <p className={`text-sm mt-2 font-medium ${isConnected ? 'text-green-600' : 'text-gray-500'}`}>
          é€£ç·šç‹€æ…‹: {connectionStatus}
        </p>
      </header>

      {/* éŒ¯èª¤è¨Šæ¯å€åŸŸ */}
      {errorMessage && (
        <div className="p-3 mb-4 text-sm text-white bg-red-500 rounded-lg shadow-md" role="alert">
          {errorMessage}
        </div>
      )}

      {/* é€£ç·šæŒ‰éˆ• */}
      <div className="mb-6">
        <button
          onClick={handleConnect}
          className={getButtonClasses('connect')}
          disabled={isSending || isBusy}
        >
          {isConnected ? 'æ–·é–‹é€£ç·š' : 'é€£ç·šè—ç‰™ (ESP32_Security_Module)'}
        </button>
      </div>

      {/* æ§åˆ¶é¢æ¿ */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        {/* è¨­é˜²/è§£é™¤æŒ‰éˆ• */}
        <button
          onClick={() => sendCommand('ARM')}
          className={getButtonClasses('arm')}
          disabled={!isConnected || securityState === SecurityState.ARMED || isSending || isBusy}
        >
          è¨­é˜² (ARM)
        </button>
        <button
          onClick={() => sendCommand('DISARM')}
          className={getButtonClasses('disarm')}
          disabled={!isConnected || securityState === SecurityState.DISARMED || isSending || isBusy}
        >
          è§£é™¤è¨­é˜² (DISARM)
        </button>
        {/* ç·Šæ€¥è­¦å ±åœæ­¢ */}
        <button
          onClick={() => sendCommand('STOP_ALARM')}
          className={getButtonClasses('alarm')}
          disabled={!isConnected || securityState !== SecurityState.ALARM_TRIGGERED || isSending || isBusy}
        >
          åœæ­¢è­¦å ± (Stop)
        </button>
      </div>
      
      {/* é–€é–èˆ‡ç…§æ˜æ§åˆ¶ */}
      <h2 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-1">è£ç½®æ§åˆ¶</h2>
      <div className="grid grid-cols-2 gap-4 mb-6">
        <button
          onClick={() => sendCommand('LOCK')}
          className={getButtonClasses('control')}
          disabled={!isConnected || isSending || isBusy}
        >
          ä¸Šé– (Lock)
        </button>
        <button
          onClick={() => sendCommand('UNLOCK')}
          className={getButtonClasses('control')}
          disabled={!isConnected || isSending || isBusy}
        >
          è§£é– (Unlock)
        </button>
        <button
          onClick={() => sendCommand('TOGGLE_LIGHT')}
          className={`${getButtonClasses('control')} col-span-2`}
          disabled={!isConnected || isSending || isBusy}
        >
          åˆ‡æ›ç…§æ˜ (Toggle Light)
        </button>
      </div>

      {/* è³‡æ–™æ“ä½œ */}
      <h2 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-1">è³‡æ–™/æ„Ÿæ‡‰å™¨æ“ä½œ</h2>
      <div className="grid grid-cols-2 gap-4 mb-6">
        <button
          onClick={() => sendCommand('READ_LOG')}
          className={getButtonClasses('data')}
          disabled={!isConnected || isSending || isBusy}
        >
          è®€å–ç´€éŒ„
        </button>
        <button
          onClick={() => sendCommand('INVENTORY')}
          className={getButtonClasses('data')}
          disabled={!isConnected || isSending || isBusy}
        >
          ç›¤æŸ¥å¡ç‰‡
        </button>
      </div>
      
      {/* ç³»çµ±æ—¥èªŒ */}
      <h2 className="text-lg font-semibold text-gray-700 mb-3 border-b pb-1">ç³»çµ±æ—¥èªŒ</h2>
      <div className="bg-white p-3 rounded-xl shadow-inner h-64 overflow-y-scroll text-xs text-gray-700 space-y-1">
        {appLog.length === 0 ? (
          <p className="text-center text-gray-400 mt-10">ç­‰å¾…è—ç‰™è¨Šæ¯...</p>
        ) : (
          appLog.map((entry) => (
            <div key={entry.id} className="border-b border-gray-100 pb-1 last:border-b-0">
              <span className="font-mono text-[10px] text-gray-400 mr-2">
                [{new Date(entry.timestamp).toLocaleTimeString()}]
              </span>
              <span className={`${entry.message.startsWith('TX:') ? 'font-medium text-blue-600' : 
                                entry.message.startsWith('ALERT:') ? 'text-red-600 font-bold' : 
                                entry.message.startsWith('LOG:') ? 'text-green-600' : 
                                'text-gray-700'}`}>
                {entry.message}
              </span>
            </div>
          ))
        )}
      </div>

      {/* Loading Indicator */}
      {(isSending || isBusy) && (
        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
          <div className="text-white text-lg font-bold p-4 bg-gray-800 rounded-lg shadow-2xl">
            {isBusy ? 'æ•¸æ“šè™•ç†ä¸­...' : 'ç™¼é€ä¸­...'}
          </div>
        </div>
      )}

      {/* Custom Modal for Alerts */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full transform transition-all scale-100">
            <h3 className="text-xl font-bold mb-3 text-red-600">ç³»çµ±é€šçŸ¥</h3>
            <p className="text-gray-700 mb-4">{modalMessage}</p>
            <button
              onClick={() => setIsModalOpen(false)}
              className="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700"
            >
              ç¢ºå®š
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;







