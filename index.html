<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP-2010 安全大師 BLE HMI (脈衝鎖)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .log-container { height: 200px; overflow-y: scroll; scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <!-- Tailwind CSS configuration (using default) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', /* Blue 500 */
                        'danger': '#ef4444', /* Red 500 */
                        'success': '#10b981', /* Emerald 500 */
                        'warning': '#f59e0b', /* Amber 500 */
                    }
                }
            }
        }
    </script>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">LP-2010 安全系統 HMI</h1>
            <p class="text-sm text-gray-500">透過藍牙與 ESP32 連線 (適用 $5$ 秒脈衝鎖)</p>
        </header>

        <!-- 連線狀態與控制 -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">連線與狀態</h2>
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div id="connectionStatus" class="font-medium px-4 py-2 rounded-full bg-gray-200 text-gray-700">未連線</div>
                <button id="connectButton" class="w-full sm:w-auto px-6 py-3 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150">
                    連線到 ESP32
                </button>
            </div>
            <div id="securityStatus" class="mt-4 text-center text-3xl font-bold py-2 rounded-lg bg-gray-200 text-gray-800">
                DISARMED (解除設防)
            </div>
            <div id="alarmMessage" class="hidden mt-4 text-center text-red-700 text-lg font-bold p-3 bg-red-100 rounded-lg animate-pulse">
                !!! 警報觸發 !!!
            </div>
        </div>

        <!-- 主要控制區塊 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            
            <!-- 設防/解除控制 -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">安全模式控制</h2>
                <div class="flex space-x-4">
                    <button id="armButton" class="flex-1 px-4 py-3 bg-success text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 transition duration-150 disabled:opacity-50">
                        設防 (ARM)
                    </button>
                    <button id="disarmButton" class="flex-1 px-4 py-3 bg-danger text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 disabled:opacity-50">
                        解除設防 (DISARM)
                    </button>
                </div>
                <button id="stopAlarmButton" class="mt-4 w-full px-4 py-3 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-150 disabled:opacity-50">
                    停止警報 / 重置
                </button>
            </div>

            <!-- I/O 與電鎖控制 (核心修正區塊) -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">門鎖與照明控制</h2>
                <div class="space-y-4">
                    <!-- 門鎖控制: 瞬時開鎖 (5秒脈衝) -->
                    <button id="unlockButton" class="w-full px-4 py-3 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150 disabled:bg-gray-400">
                        開門 5 秒 (UNLOCK)
                    </button>
                    
                    <!-- 移除「關鎖」按鈕，由韌體自動控制 -->
                    
                    <button id="toggleLightButton" class="w-full px-4 py-3 bg-warning text-gray-800 font-semibold rounded-lg shadow-md hover:bg-amber-500 transition duration-150 disabled:opacity-50">
                        切換照明 (D4)
                    </button>
                </div>
            </div>
            
            <!-- 紀錄/RFID 讀取 -->
            <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-2">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">紀錄與 RFID 存取</h2>
                <div class="flex space-x-4">
                    <button id="readLogButton" class="flex-1 px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150 disabled:opacity-50">
                        讀取登錄紀錄
                    </button>
                    <button id="readInventoryButton" class="flex-1 px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150 disabled:opacity-50">
                        盤查 RFID 卡片
                    </button>
                </div>
            </div>

        </div>

        <!-- 系統日誌顯示區 -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">系統日誌</h2>
            <div id="log" class="log-container bg-gray-50 p-3 rounded-lg text-sm text-gray-600 space-y-1">
                <!-- 日誌訊息將顯示在此處 -->
            </div>
        </div>

    </div>

    <script>
        // --- 全局變數 ---
        let device, server, service, rxCharacteristic, txCharacteristic;
        const BLE_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // 用於 Write (發送命令給 ESP32)
        const BLE_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // 用於 Notify (接收狀態)
        
        let unlockTimer = null; // 用於門鎖倒數計時器
        const UNLOCK_DURATION = 5; // 倒數 5 秒

        // --- DOM 元素快取 ---
        const connectButton = document.getElementById('connectButton');
        const connectionStatus = document.getElementById('connectionStatus');
        const securityStatusDiv = document.getElementById('securityStatus');
        const alarmMessageDiv = document.getElementById('alarmMessage');
        const logContainer = document.getElementById('log');
        const unlockButton = document.getElementById('unlockButton');
        const stopAlarmButton = document.getElementById('stopAlarmButton');
        const armButton = document.getElementById('armButton');
        const disarmButton = document.getElementById('disarmButton');
        const toggleLightButton = document.getElementById('toggleLightButton');
        const readLogButton = document.getElementById('readLogButton');
        const readInventoryButton = document.getElementById('readInventoryButton');


        // --- 輔助函式 ---

        /**
         * 將訊息新增到日誌視窗
         * @param {string} message - 要顯示的訊息
         * @param {string} level - 訊息級別 (e.g., 'INFO', 'ERROR')
         */
        function logMessage(message, level = 'INFO') {
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const newLogEntry = document.createElement('p');
            newLogEntry.innerHTML = `<span class="font-mono text-xs text-gray-400">[${timeStr}]</span> <span class="font-semibold text-xs">${level}:</span> ${message}`;
            
            // 根據級別設定顏色
            if (level === 'ERROR') {
                newLogEntry.classList.add('text-danger');
            } else if (level === 'WARNING') {
                newLogEntry.classList.add('text-warning');
            }

            logContainer.appendChild(newLogEntry);
            // 滾動到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        /**
         * 發送命令到 ESP32
         * @param {string} command - 要發送的命令字串
         */
        async function sendCommand(command) {
            if (!rxCharacteristic) {
                logMessage('藍牙尚未連線或特性不可用', 'ERROR');
                return;
            }
            try {
                // 將命令字串轉換為 Uint8Array
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                await rxCharacteristic.writeValue(data);
                logMessage(`TX: ${command}`, 'INFO');
            } catch (error) {
                logMessage(`發送命令失敗: ${error.message}`, 'ERROR');
            }
        }

        // --- 藍牙核心功能 ---

        async function connectBLE() {
            logMessage('嘗試連線...');
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'ESP32' }], // 依名稱前綴過濾
                    optionalServices: [BLE_UART_SERVICE_UUID]
                });

                connectionStatus.textContent = '連線中...';
                connectionStatus.classList.remove('bg-gray-200', 'bg-danger');
                connectionStatus.classList.add('bg-warning', 'text-gray-900');

                // 註冊斷開事件
                device.addEventListener('gattserverdisconnected', onDisconnected);

                const gattServer = await device.gatt.connect();
                server = gattServer;

                service = await server.getPrimaryService(BLE_UART_SERVICE_UUID);
                rxCharacteristic = await service.getCharacteristic(BLE_RX_CHARACTERISTIC_UUID); // Write (TX from HMI)
                txCharacteristic = await service.getCharacteristic(BLE_TX_CHARACTERISTIC_UUID); // Notify (RX to HMI)

                // 啟用通知
                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                connectionStatus.textContent = `已連線: ${device.name}`;
                connectionStatus.classList.remove('bg-warning');
                connectionStatus.classList.add('bg-success', 'text-white');
                logMessage('藍牙連線成功，已啟用通知。', 'SUCCESS');
                connectButton.textContent = '斷開連線';

                // 啟用所有控制按鈕
                [armButton, disarmButton, toggleLightButton, readLogButton, readInventoryButton].forEach(btn => btn.disabled = false);

            } catch (error) {
                logMessage(`連線失敗: ${error.message}`, 'ERROR');
                connectionStatus.textContent = '連線失敗';
                connectionStatus.classList.remove('bg-warning');
                connectionStatus.classList.add('bg-danger', 'text-white');
                connectButton.textContent = '重新連線';
            }
        }

        function onDisconnected(event) {
            const device = event.target;
            logMessage(`裝置 "${device.name}" 已斷開連線`, 'ERROR');
            connectionStatus.textContent = '已斷開連線';
            connectionStatus.classList.remove('bg-success');
            connectionStatus.classList.add('bg-danger', 'text-white');
            connectButton.textContent = '連線到 ESP32';
            // 禁用所有控制按鈕
            [armButton, disarmButton, unlockButton, stopAlarmButton, toggleLightButton, readLogButton, readInventoryButton].forEach(btn => btn.disabled = true);
            // 停止可能的門鎖計時器
            stopUnlockCountdown();
        }

        /**
         * 處理來自 ESP32 的通知 (Notification)
         */
        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const receivedText = decoder.decode(value);
            
            // 1. 處理狀態更新 (STATUS:)
            if (receivedText.startsWith('STATUS:')) {
                const status = receivedText.substring(7).trim();
                securityStatusDiv.textContent = status;
                
                // 根據狀態設定顏色
                securityStatusDiv.classList.remove('bg-success', 'bg-danger', 'bg-gray-200');
                alarmMessageDiv.classList.add('hidden');
                stopAlarmButton.disabled = false;

                if (status === 'ARMED') {
                    securityStatusDiv.classList.add('bg-success', 'text-white');
                } else if (status === 'DISARMED') {
                    securityStatusDiv.classList.add('bg-gray-200', 'text-gray-800');
                } else if (status === 'ALARM_TRIGGERED') {
                    securityStatusDiv.classList.add('bg-danger', 'text-white');
                    alarmMessageDiv.classList.remove('hidden');
                }
                logMessage(`系統狀態更新為: ${status}`, 'WARNING');

            // 2. 處理一般日誌 (LOG:)
            } else if (receivedText.startsWith('LOG:')) {
                const message = receivedText.substring(4);
                logMessage(message.trim());
            
            // 3. 處理日誌/RFID 資料 (LOG_DATA:)
            } else if (receivedText.startsWith('LOG_DATA:')) {
                const data = receivedText.substring(9).trim();
                logMessage(`[紀錄資料] ${data}`, 'INFO');

            // 4. 處理 I/O IN 資料 (LP_DATA:) - 顯示 LP-2010 原始 IN 狀態
            } else if (receivedText.startsWith('LP_DATA:')) {
                const data = receivedText.substring(8).trim();
                // 可以在這裡顯示 I/O IN 原始十六進制數據
                // logMessage(`[I/O IN] ${data}H`);
            }
        }

        // --- 門鎖脈衝邏輯 (核心修正) ---
        
        /**
         * 啟動門鎖倒數計時器
         */
        function startUnlockCountdown() {
            let secondsLeft = UNLOCK_DURATION;
            // 立即發送 UNLOCK 命令給 ESP32 (D7=1)
            sendCommand('UNLOCK'); 

            unlockButton.disabled = true;
            stopAlarmButton.disabled = true; // 解鎖時無法停止警報
            
            // 倒數計時
            unlockTimer = setInterval(() => {
                secondsLeft--;
                if (secondsLeft >= 0) {
                    unlockButton.textContent = `解鎖中... ${secondsLeft} 秒後自動上鎖`;
                    unlockButton.classList.add('bg-gray-400');
                    unlockButton.classList.remove('bg-primary', 'hover:bg-blue-600');
                } else {
                    stopUnlockCountdown();
                }
            }, 1000);
        }

        /**
         * 停止門鎖倒數計時器並重置按鈕狀態
         */
        function stopUnlockCountdown() {
            if (unlockTimer) {
                clearInterval(unlockTimer);
                unlockTimer = null;
            }
            unlockButton.textContent = '開門 5 秒 (UNLOCK)';
            unlockButton.disabled = false;
            stopAlarmButton.disabled = false;
            unlockButton.classList.remove('bg-gray-400');
            unlockButton.classList.add('bg-primary', 'hover:bg-blue-600');
        }

        // --- 事件監聽器設定 ---
        connectButton.addEventListener('click', async () => {
            if (server && server.connected) {
                try {
                    await server.disconnect();
                    onDisconnected({ target: device }); // 手動觸發斷線邏輯
                } catch (e) {
                    logMessage(`斷開連線失敗: ${e.message}`, 'ERROR');
                }
            } else {
                connectBLE();
            }
        });

        // 控制按鈕的監聽器
        armButton.addEventListener('click', () => sendCommand('ARM'));
        disarmButton.addEventListener('click', () => sendCommand('DISARM'));
        stopAlarmButton.addEventListener('click', () => sendCommand('STOP_ALARM'));
        toggleLightButton.addEventListener('click', () => sendCommand('TOGGLE_LIGHT'));
        readLogButton.addEventListener('click', () => sendCommand('READ_LOG'));
        readInventoryButton.addEventListener('click', () => sendCommand('INVENTORY'));

        // 門鎖按鈕使用新的脈衝邏輯
        unlockButton.addEventListener('click', startUnlockCountdown); 
        // 移除對 'LOCK' 按鈕的監聽器

        // 初始化：禁用控制按鈕直到連線成功
        document.addEventListener('DOMContentLoaded', () => {
            [armButton, disarmButton, unlockButton, stopAlarmButton, toggleLightButton, readLogButton, readInventoryButton].forEach(btn => btn.disabled = true);
            logMessage('介面準備就緒。請點擊連線按鈕。');
        });

    </script>
</body>
</html>








