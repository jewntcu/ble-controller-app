<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行動安全系統藍牙控制器</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設定 Tailwind 樣式和字體 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .log-area {
            height: 280px;
            overflow-y: scroll;
            scroll-behavior: smooth;
        }
        .control-btn {
            @apply p-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-opacity-50;
        }
        /* 針對狀態按鈕的動畫 */
        .state-btn-armed {
            @apply bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-500;
        }
        .state-btn-disarmed {
            @apply bg-green-500 text-white hover:bg-green-600 focus:ring-green-500;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-2xl p-6 md:p-10 border-t-4 border-blue-500">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-blue-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                行動安全系統藍牙控制器
            </h1>
            <p class="text-sm text-gray-500 mt-1">透過 Web Bluetooth 與 ESP32 進行 BLE (Nordic UART Service) 通訊。</p>
        </header>

        <!-- 連線/狀態面板 -->
        <section class="mb-8 p-5 bg-gray-100 rounded-xl flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 shadow-inner">
            <div class="flex items-center space-x-4">
                <div id="status-icon" class="p-3 rounded-full bg-gray-400 text-white">
                    <svg id="icon-disconnected" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi-off"><path d="M5 2L2 5"/><path d="M22 22L2 22"/><path d="M2 12h20"/><path d="M22 5L5 22"/></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">連線狀態</p>
                    <p id="status-display" class="text-xl font-bold text-gray-800">未連線</p>
                </div>
            </div>
            
            <button id="connect-button"
                    class="py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                啟動連線
            </button>
        </section>

        <!-- 控制命令區塊 -->
        <section class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- 設防/解除按鈕 -->
            <button id="btn-arm" data-command="ARM" disabled
                    class="control-btn state-btn-disarmed lg:col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M12 2L3 8v6c0 5.5 3.5 10.5 8 13.5M12 2V25"/><path d="M18 10L12 16L6 10"/></svg>
                <span class="font-bold text-lg">設防 (ARM)</span>
            </button>
            <button id="btn-disarm" data-command="DISARM" disabled
                    class="control-btn bg-gray-300 text-gray-800 hover:bg-gray-400 focus:ring-gray-300 lg:col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M12 2L3 8v6c0 5.5 3.5 10.5 8 13.5M12 2V25"/><path d="M18 10L12 16L6 10"/></svg>
                <span class="font-bold text-lg">解除設防 (DISARM)</span>
            </button>

            <!-- 門鎖控制 -->
            <button id="btn-lock" data-command="LOCK" disabled
                    class="control-btn bg-red-500 text-white hover:bg-red-600 focus:ring-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                <span class="font-medium">上鎖</span>
            </button>
            <button id="btn-unlock" data-command="UNLOCK" disabled
                    class="control-btn bg-teal-500 text-white hover:bg-teal-600 focus:ring-teal-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 5-5h0a5 5 0 0 1 5 5v4"/></svg>
                <span class="font-medium">開鎖</span>
            </button>
            
            <!-- 照明控制 -->
            <button id="btn-light" data-command="LIGHT" disabled
                    class="control-btn bg-indigo-500 text-white hover:bg-indigo-600 focus:ring-indigo-500 col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M15 14V11a3 3 0 0 0-6 0v3"/><path d="M8 20h8"/><path d="M12 14v6"/><path d="M17.8 7.8 19 6.6"/><path d="m4.2 7.8 1.2-1.2"/><path d="M12 2v2"/><path d="M20 12h-2"/><path d="M6 12H4"/></svg>
                <span class="font-medium">切換照明</span>
            </button>
        </section>

        <!-- 訊息日誌區塊 (TX Characteristic Notifications) -->
        <section class="p-5 bg-gray-800 rounded-xl shadow-xl">
            <h2 class="text-xl font-semibold text-white mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-yellow-400"><path d="M2 12s3-3 5-3 5 3 5 3 3-3 5-3 5 3 5 3"/><path d="M22 22L2 22"/></svg>
                系統訊息日誌 (裝置回應)
            </h2>
            <div id="log-container" class="log-area p-3 bg-gray-900 text-green-400 rounded-lg text-sm font-mono">
                <!-- Log messages will be appended here -->
                <p>--- 應用程式已啟動 (SSR 檢查通過) ---</p>
            </div>
            <button id="clear-log-button" 
                    class="mt-3 py-1 px-4 text-xs bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                清除日誌
            </button>
        </section>
    </div>

    <script type="module">
        // ----------------------------------------------------
        // 1. 環境初始化 (Firebase 和 Auth)
        // 這是 Canvas 環境的要求，確保應用程式可以運行
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // setLogLevel('Debug'); // 開啟 Firestore 偵錯日誌
            
            // 處理認證
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Firebase Custom Token 登入失敗:", e);
                    signInAnonymously(auth); // Fallback to anonymous
                });
            } else {
                signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase 初始化失敗:", error);
        }

        // ----------------------------------------------------
        // 2. Web Bluetooth API 邏輯 (核心)
        // ----------------------------------------------------
        
        // BLE NUS (Nordic UART Service) UUIDs - 與您的韌體設定一致
        const BLE_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // 用於接收通知
        const BLE_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // 用於發送指令
        const COMMAND_TERMINATOR = '\n'; // 假設指令結尾是換行符

        // 狀態和特性值變數
        let bleDevice = null;
        let rxCharacteristic = null; 
        let txCharacteristic = null;
        let isArmed = false; // 追蹤應用程式內的設防狀態

        // UI 元素
        const statusDisplay = document.getElementById('status-display');
        const statusIcon = document.getElementById('status-icon');
        const connectButton = document.getElementById('connect-button');
        const logContainer = document.getElementById('log-container');
        const clearLogButton = document.getElementById('clear-log-button');
        const controlButtons = document.querySelectorAll('[data-command]');
        const btnArm = document.getElementById('btn-arm');
        const btnDisarm = document.getElementById('btn-disarm');

        // Helper: Log message to UI
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logElement = document.createElement('p');
            logElement.textContent = `[${time}] ${message}`;

            if (type === 'error') {
                logElement.className = 'text-red-400 font-bold';
            } else if (type === 'rx') { // 裝置回覆
                logElement.className = 'text-yellow-300';
            } else if (type === 'tx') { // 指令發送
                logElement.className = 'text-blue-300';
            } else { // info / system
                logElement.className = 'text-green-400';
            }
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Helper: 更新連線/控制狀態 UI
        function updateUIState(isConnected, statusText = '未連線') {
            statusDisplay.textContent = statusText;
            
            // 更新狀態圖示和顏色
            let iconSvg;
            if (statusText === '連線中') {
                statusDisplay.className = 'font-bold text-xl text-blue-600';
                statusIcon.className = 'p-3 rounded-full bg-blue-500 text-white animate-pulse';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
            } else if (isConnected) {
                statusDisplay.className = 'font-bold text-xl text-green-600';
                statusIcon.className = 'p-3 rounded-full bg-green-500 text-white';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bluetooth"><path d="m7 7 10 10-5 5V2l5 5L7 17"/></svg>`;
            } else { // 未連線
                statusDisplay.className = 'font-bold text-xl text-red-600';
                statusIcon.className = 'p-3 rounded-full bg-gray-400 text-white';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi-off"><path d="M5 2L2 5"/><path d="M22 22L2 22"/><path d="M2 12h20"/><path d="M22 5L5 22"/></svg>`;
                isArmed = false;
            }
            statusIcon.innerHTML = iconSvg;

            // 更新按鈕狀態
            connectButton.disabled = isConnected;
            connectButton.textContent = isConnected ? '已連線' : '啟動連線';
            controlButtons.forEach(btn => btn.disabled = !isConnected);

            // 處理設防/解除按鈕的外觀
            btnArm.classList.remove('state-btn-armed', 'bg-green-500');
            btnDisarm.classList.remove('state-btn-disarmed', 'bg-gray-300');

            if (isArmed) {
                btnArm.classList.add('state-btn-armed');
                btnDisarm.classList.add('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400', 'focus:ring-gray-300');
                btnArm.disabled = true;
                btnDisarm.disabled = false;
            } else if (isConnected) {
                btnDisarm.classList.add('state-btn-disarmed');
                btnArm.classList.add('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400', 'focus:ring-gray-300');
                btnArm.disabled = false;
                btnDisarm.disabled = true;
            }
        }

        // --- BLE 核心功能 ---

        // 處理來自 TX Characteristic 的數據通知
        function handleNotifications(event) {
            const value = event.target.value;
            // 數據處理：將 DataView 轉換為字串
            const data = new TextDecoder().decode(value);
            log(`裝置回覆: ${data.trim()}`, 'rx');

            // 處理特定的狀態更新 (如果韌體有回覆)
            if (data.includes('ARMED')) {
                isArmed = true;
                updateUIState(true, '設防中 (ARMED)');
            } else if (data.includes('DISARMED')) {
                isArmed = false;
                updateUIState(true, '解除設防 (DISARMED)');
            } else if (data.includes('ALARM_TRIGGERED')) {
                updateUIState(true, '警報觸發!!!');
            }
        }

        // 處理裝置斷開連線
        function onDisconnected(event) {
            log(`裝置已斷開連線: ${event.target.name || 'Unknown Device'}`, 'error');
            updateUIState(false);
            bleDevice = null;
            rxCharacteristic = null;
            txCharacteristic = null;
        }
        
        // 發送指令到 RX Characteristic
        async function sendCommand(command) {
            if (!rxCharacteristic) {
                log('發送失敗: 尚未連線到裝置或 RX 特性值無效。', 'error');
                updateUIState(false, '連線失敗');
                return;
            }
            
            const fullCommand = command + COMMAND_TERMINATOR;

            try {
                // 將字串轉換為 ArrayBuffer/Uint8Array
                const encoder = new TextEncoder();
                const data = encoder.encode(fullCommand);
                
                // 寫入數據
                await rxCharacteristic.writeValue(data);
                log(`發送指令: ${fullCommand.trim()}`, 'tx');

                // 模擬狀態更新 (實際應該依賴 TX 通知)
                if (command === 'ARM') {
                    updateUIState(true, '設防中 (等待裝置確認...)');
                } else if (command === 'DISARM') {
                    updateUIState(true, '解除設防 (等待裝置確認...)');
                }

            } catch (error) {
                log(`發送指令失敗: ${error.message}`, 'error');
            }
        }

        // 連線流程
        async function connect() {
            // SSR 安全檢查 (確保只在客戶端執行)
            if (typeof window === 'undefined' || !navigator.bluetooth) {
                log('錯誤: 瀏覽器不支援 Web Bluetooth API 或正在伺服器端執行。請使用 Chrome/Edge 瀏覽器。', 'error');
                updateUIState(false, '不支援 BLE');
                return;
            }

            updateUIState(false, '掃描中...');
            log('正在請求藍牙裝置...');
            connectButton.disabled = true;

            try {
                // 1. 請求 BLE 裝置
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLE_UART_SERVICE_UUID] }],
                    optionalServices: [BLE_UART_SERVICE_UUID], 
                });

                log(`已找到裝置: ${bleDevice.name || bleDevice.id}`);
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                // 2. 連線到 GATT 伺服器
                updateUIState(false, '連線 GATT 伺服器...');
                const server = await bleDevice.gatt.connect();

                // 3. 取得服務
                updateUIState(false, '取得 UART 服務...');
                const service = await server.getPrimaryService(BLE_UART_SERVICE_UUID);

                // 4. 取得特性值 (RX/TX)
                updateUIState(false, '取得特性值...');
                rxCharacteristic = await service.getCharacteristic(BLE_RX_CHARACTERISTIC_UUID);
                txCharacteristic = await service.getCharacteristic(BLE_TX_CHARACTERISTIC_UUID);
                
                // 5. 啟動通知 (Notifications)
                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                updateUIState(true, '解除設防 (DISARMED)'); // 預設連線成功後為解除設防
                isArmed = false;
                log('*** 成功連線到裝置！ ***');

            } catch (error) {
                log(`連線失敗: ${error.name || error.message}`, 'error');
                updateUIState(false);
            } finally {
                connectButton.disabled = false;
            }
        }
        
        // --- 事件監聽器 ---

        // 連線按鈕
        connectButton.addEventListener('click', () => {
            if (bleDevice && bleDevice.gatt.connected) {
                // 如果已經連線，點擊按鈕就斷開
                if (bleDevice.gatt.connected) {
                    bleDevice.gatt.disconnect();
                }
            } else {
                connect();
            }
        });
        
        // 指令按鈕
        controlButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                if (!e.currentTarget.disabled) {
                    const command = e.currentTarget.dataset.command;
                    sendCommand(command);
                }
            });
        });

        // 清除日誌按鈕
        clearLogButton.addEventListener('click', () => {
            logContainer.innerHTML = '<p>--- 日誌已清除 ---</p>';
        });

        // 應用程式啟動時的初始狀態
        updateUIState(false);
    </script>
</body>
</html>
