import React, { useState, useCallback, useEffect, useMemo } from 'react';
import { Power, Lock, Unlock, Zap, Bluetooth, WifiOff, AlertTriangle, MessageSquare, Loader } from 'lucide-react';

// --- 藍牙服務和特性 UUIDs ---
// 確保 UUID 是完整的，這裡使用了一個常見的 UART 服務範例。
const BLE_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const BLE_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const BLE_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

// 指令結尾定義
const APP_TERMINATOR = '\n';

// 系統狀態
const SecurityStateMap = {
  DISARMED: '解除設防',
  ARMED: '設防中',
  ALARM_TRIGGERED: '警報觸發',
  CONNECTING: '連線中',
  DISCONNECTED: '已斷線',
};

// 狀態顏色對應
const statusColors = {
    DISARMED: 'bg-green-500',
    ARMED: 'bg-yellow-500',
    ALARM_TRIGGERED: 'bg-red-500',
    CONNECTING: 'bg-blue-500',
    DISCONNECTED: 'bg-gray-400',
};

// 輔助函式：模擬 BLE 寫入操作
const sendCommand = (command, characteristic) => {
    // 實際應用中，這裡會是 characteristic.writeValue(command + APP_TERMINATOR);
    console.log(`[BLE TX 模擬] 發送指令: ${command}`);
    // 模擬韌體回覆
    setTimeout(() => {
        handleLog(`系統回應: 收到指令 ${command}`);
    }, 500);
};

// 輔助函式：處理日誌輸出
let setLogHistoryRef;
const handleLog = (message) => {
    if (setLogHistoryRef) {
        setLogHistoryRef(prev => [
            `[${new Date().toLocaleTimeString()}] ${message}`,
            ...prev,
        ].slice(0, 10)); // 只保留最新的 10 條日誌
    }
};

const App = () => {
    // 狀態管理
    const [securityState, setSecurityState] = useState('DISCONNECTED');
    const [logHistory, setLogHistory] = useState([]);
    const [isConnecting, setIsConnecting] = useState(false);
    const [lightState, setLightState] = useState(false);
    
    // 將 setLogHistory 存入 ref 供輔助函式使用
    setLogHistoryRef = setLogHistory;

    // 模擬 GATT 特性 (在實際應用中，這些會是真實的 BLE 實例)
    const gattRef = React.useRef({
        device: null,
        txCharacteristic: null,
        rxCharacteristic: null,
    });

    const currentStatusColor = statusColors[securityState] || statusColors.DISCONNECTED;
    const currentStatusText = SecurityStateMap[securityState] || SecurityStateMap.DISCONNECTED;

    /**
     * @brief 處理狀態切換和指令發送
     * @param {string} newState - DISARMED | ARMED | ALARM_TRIGGERED
     */
    const setDeviceState = useCallback((newState) => {
        if (securityState === 'DISCONNECTED') return handleLog('錯誤: 請先連線到裝置');

        // 模擬 BLE 指令發送
        let command = '';
        switch (newState) {
            case 'ARMED':
                command = 'ARM';
                break;
            case 'DISARMED':
                command = 'DISARM';
                break;
            case 'STOP_ALARM': // 用於警報觸發後解除
                command = 'STOP_ALARM';
                break;
            default:
                return;
        }

        sendCommand(command, gattRef.current.rxCharacteristic);
        setSecurityState(newState); // 假設指令發送成功即更新 UI 狀態
        handleLog(`已切換至 ${SecurityStateMap[newState]}`);
    }, [securityState]);


    /**
     * @brief [SSR 修正重點] 處理藍牙連線邏輯
     * 此函式只會在使用者點擊按鈕後，在瀏覽器環境中執行
     */
    const handleConnect = useCallback(async () => {
        // 關鍵 SSR 安全檢查
        if (typeof window === 'undefined' || !navigator.bluetooth) {
            handleLog('錯誤: 瀏覽器不支援 Web Bluetooth 或正在伺服器端執行。');
            return;
        }

        if (securityState !== 'DISCONNECTED') {
            handleLog('已連線或正在連線中。');
            return;
        }

        setIsConnecting(true);
        setSecurityState('CONNECTING');
        handleLog('嘗試連線至 ESP32 藍牙裝置...');

        try {
            // 模擬請求裝置 (實際需要補齊完整的藍牙連線代碼)
            // const device = await navigator.bluetooth.requestDevice({...});
            // const server = await device.gatt.connect();
            
            // 模擬連線成功
            await new Promise(resolve => setTimeout(resolve, 2000)); 
            
            gattRef.current.device = { name: 'ESP32_BLE_Controller (模擬)' };
            
            setSecurityState('DISARMED'); // 連線成功後預設為解除設防
            handleLog(`成功連線至 ${gattRef.current.device.name}`);

        } catch (error) {
            handleLog(`連線失敗: ${error.message}`);
            setSecurityState('DISCONNECTED');
        } finally {
            setIsConnecting(false);
        }
    }, [securityState]);


    // --- UI 輔助函式 ---

    const handleLockControl = (isLock) => {
        const command = isLock ? 'LOCK' : 'UNLOCK';
        sendCommand(command, gattRef.current.rxCharacteristic);
        handleLog(`門鎖: ${isLock ? '已上鎖 (LOCK)' : '已開鎖 (UNLOCK)'}`);
    };

    const handleToggleLight = () => {
        const newState = !lightState;
        const command = 'TOGGLE_LIGHT'; // 假設韌體會處理切換邏輯
        sendCommand(command, gattRef.current.rxCharacteristic);
        setLightState(newState);
        handleLog(`照明: 已${newState ? '開啟' : '關閉'}`);
    };

    const isReady = securityState !== 'DISCONNECTED' && securityState !== 'CONNECTING';

    return (
        <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-inter">
            <script src="https://cdn.tailwindcss.com"></script>
            <div className="max-w-4xl mx-auto">
                {/* 標題與狀態面板 */}
                <header className="mb-8 p-4 bg-white shadow-xl rounded-xl">
                    <h1 className="text-3xl font-bold text-gray-800 flex items-center">
                        BLE 系統控制器
                    </h1>
                    <div className="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div className="flex items-center space-x-3">
                            <div className={`p-2 rounded-full ${currentStatusColor} text-white`}>
                                {isConnecting ? <Loader className="animate-spin" size={24} /> : (
                                    securityState === 'DISCONNECTED' ? <WifiOff size={24} /> : <Bluetooth size={24} />
                                )}
                            </div>
                            <div>
                                <p className="text-sm text-gray-500">當前狀態</p>
                                <p className="text-xl font-semibold text-gray-900">{currentStatusText}</p>
                            </div>
                        </div>
                        
                        {/* 連線按鈕 */}
                        <button
                            onClick={handleConnect}
                            disabled={isConnecting || securityState !== 'DISCONNECTED'}
                            className={`mt-4 sm:mt-0 px-6 py-2 rounded-lg font-medium transition-all duration-300 shadow-md 
                                ${isConnecting 
                                    ? 'bg-blue-300 text-white cursor-not-allowed'
                                    : securityState === 'DISCONNECTED' 
                                        ? 'bg-blue-600 hover:bg-blue-700 text-white'
                                        : 'bg-green-400 text-gray-800 cursor-default'
                                }`}
                        >
                            {isConnecting ? '連線中...' : (securityState !== 'DISCONNECTED' ? '已連線' : '啟動連線')}
                        </button>
                    </div>
                </header>

                {/* 控制面板 */}
                <main className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* 1. 安全控制 */}
                    <div className="lg:col-span-2 bg-white p-6 shadow-xl rounded-xl">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center"><AlertTriangle className="mr-2" /> 安全系統控制</h2>
                        <div className="grid grid-cols-2 gap-4">
                            <button
                                onClick={() => setDeviceState('ARMED')}
                                disabled={!isReady || securityState === 'ARMED'}
                                className={`flex flex-col items-center p-4 rounded-lg transition-all duration-300 h-28
                                    ${securityState === 'ARMED' ? 'bg-yellow-400 text-white shadow-inner' : 'bg-gray-100 hover:bg-yellow-100 text-gray-800 shadow-md'}
                                    ${!isReady ? 'opacity-50 cursor-not-allowed' : ''}`}
                            >
                                <Zap size={32} />
                                <span className="mt-2 font-medium">設防 (ARM)</span>
                                {securityState === 'ARMED' && <span className="text-xs">已啟動</span>}
                            </button>
                            <button
                                onClick={() => setDeviceState('DISARMED')}
                                disabled={!isReady || securityState === 'DISARMED'}
                                className={`flex flex-col items-center p-4 rounded-lg transition-all duration-300 h-28
                                    ${securityState === 'DISARMED' ? 'bg-green-400 text-white shadow-inner' : 'bg-gray-100 hover:bg-green-100 text-gray-800 shadow-md'}
                                    ${!isReady ? 'opacity-50 cursor-not-allowed' : ''}`}
                            >
                                <Power size={32} />
                                <span className="mt-2 font-medium">解除設防 (DISARM)</span>
                                {securityState === 'DISARMED' && <span className="text-xs">已解除</span>}
                            </button>
                            
                            {securityState === 'ALARM_TRIGGERED' && (
                                <button
                                    onClick={() => setDeviceState('DISARMED')} // 或 'STOP_ALARM'
                                    className="col-span-2 flex flex-col items-center justify-center p-4 rounded-lg bg-red-600 hover:bg-red-700 text-white shadow-xl animate-pulse"
                                >
                                    <AlertTriangle size={32} />
                                    <span className="mt-2 font-bold text-lg">解除警報 (STOP ALARM)</span>
                                </button>
                            )}
                        </div>
                    </div>

                    {/* 2. 其他控制 */}
                    <div className="lg:col-span-1 bg-white p-6 shadow-xl rounded-xl">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">週邊控制</h2>
                        <div className="space-y-3">
                            {/* 門鎖控制 */}
                            <div className="flex justify-between items-center space-x-2">
                                <p className="font-medium text-gray-700">門鎖</p>
                                <div className="flex space-x-2">
                                    <button 
                                        onClick={() => handleLockControl(true)}
                                        disabled={!isReady}
                                        className="p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md disabled:opacity-50"
                                        title="上鎖"
                                    >
                                        <Lock size={20} />
                                    </button>
                                    <button 
                                        onClick={() => handleLockControl(false)}
                                        disabled={!isReady}
                                        className="p-3 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-md disabled:opacity-50"
                                        title="解鎖"
                                    >
                                        <Unlock size={20} />
                                    </button>
                                </div>
                            </div>
                            
                            {/* 照明控制 */}
                            <div className="flex justify-between items-center space-x-2">
                                <p className="font-medium text-gray-700">照明 (R1)</p>
                                <button 
                                    onClick={handleToggleLight}
                                    disabled={!isReady}
                                    className={`p-3 rounded-lg shadow-md disabled:opacity-50 transition-colors ${lightState ? 'bg-yellow-400 text-gray-800 hover:bg-yellow-500' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                                >
                                    <Zap size={20} className={lightState ? 'fill-current' : ''} />
                                </button>
                            </div>
                            
                            {/* RFID 盤查 */}
                            <button
                                disabled={!isReady}
                                onClick={() => sendCommand('READ_CARD', gattRef.current.rxCharacteristic)}
                                className="w-full p-3 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-lg shadow-md transition-colors disabled:opacity-50"
                            >
                                RFID 盤查
                            </button>
                        </div>
                    </div>
                </main>

                {/* 日誌面板 */}
                <section className="mt-6 bg-white p-6 shadow-xl rounded-xl">
                    <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center"><MessageSquare className="mr-2" /> 系統日誌</h2>
                    <div className="h-64 overflow-y-auto bg-gray-900 text-gray-100 p-3 rounded-lg text-sm font-mono">
                        {logHistory.length === 0 ? (
                            <p className="text-gray-500">日誌待機中...請嘗試連線。</p>
                        ) : (
                            logHistory.map((log, index) => (
                                <p key={index} className={log.includes('錯誤') ? 'text-red-400' : log.includes('成功') ? 'text-green-400' : 'text-gray-300'}>
                                    {log}
                                </p>
                            ))
                        )}
                    </div>
                </section>
            </div>
        </div>
    );
};

export default App;





